<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<script>
			function cssLoad(src) {
				if (!src) {
					return Promise.resolve();
				}
				return new Promise((resolve, reject) => {
					let s = document.createElement('link');
					s.rel = 'stylesheet';
					s.href = src;
					s.onload = resolve;
					s.onerror = reject;
					document.head.append(s);
				});
			}
		</script>
		<script>
			function jsLoad(src, module=false) {
				if (!src) {
					return Promise.resolve();
				}
				return new Promise((resolve, reject) => {
					let s = document.createElement('script');
					s.src = src;
					if (module) {
						s.type='module';
					}
					s.onload = resolve;
					s.onerror = reject;
					document.head.append(s);
				});
			}
		</script>
		<script>
			function prependScript(url) {
				return new Promise((resolve, reject) => {
					let s = document.createElement('script');
					s.src = url;
					s.onload = resolve;
					s.onerror = reject;
					document.currentScript.parentNode.insertBefore(
						s,
						document.currentScript,
					);
				});
			}
		</script>
		
		<style>
			body {
				/*margin: 0px;*/
				margin-left: 0;
				margin-right: 0;
			}
			div#sqlDiv, #map {
				width: 98vw;
				height: 59vh;
				margin-top: 1vh;
				margin-right: 1vw;
				margin-left: 1vw;
				border: solid 1px gray;
				
				/*position: fixed;*/
			}
		</style>
		<title>
			spl-view
		</title>
	</head>
	<body>
		
		<script>


const natural_earth_local = new URL('./test/files/dbs/Natural_Earth_QGIS_layers_and_styles.gpkg', window.location.href).toString();
const dctour_remote = 'https://github.com/ngageoint/geopackage-js/raw/master/docs/examples/GoingOfflineWithGeoPackage/public/DCTour.gpkg';
const dctour_local = new URL('./test/files/dbs/dctour.gpkg', window.location.href).toString();
const rivers_remote = 'https://www.geopackage.org/data/rivers.gpkg';
const rivers_local = new URL('./test/files/dbs/rivers.gpkg', window.location.href).toString();
const db_small = new URL('./test/files/dbs/db_small.sqlite', window.location.href).toString();

// mountpoint/filename has to be unique.
/**
//let url = rivers_local;
//let url = natural_earth_local;
//let url = dctour_local;
let url = db_small;
window.userData = [
	{
		mountpoint: 'data',
		filename: 'db.sqlite',
		isdb: true,
		url,
		method: 'arrayBuffer',
	},
];
/**/

let program;
program = "./stlouis.js";
//program = "./london_boroughs.js";
//program = "./lights.js";
//program = "./tri.js";

const driver_href = "./lib/map_show.js";
const driver_url = new URL(driver_href, window.location.href).toString();
Promise.all([
	jsLoad(driver_url),
])
.then(() => Promise.all([
	jsLoad("./lib/proj4.js"),
	jsLoad("./lib/sqlitexplore.js"),
	jsLoad("./lib/map_show_leaflet.js"),
	jsLoad("./lib/map_show_ol.js"),
]))
.then(() => {
	window.DisplayClass =
	DisplayLeaflet
	//DisplayOpenLayers
	;
	return Promise.all(
		window.DisplayClass.resources(driver_url)
	);
})
.then(() => {
	if (1) {
		let html = `<div id="sqlDiv"></div>`;
		document.body.insertAdjacentHTML('beforeend', html);
		let div = document.querySelector('div#sqlDiv');
		window.xplorer = new SQLiteXplore(div, {
			build_map: window.DisplayClass,
			withProj4JS: true,
		});
		window.map = window.xplorer.getMap();
	}
	else {
		let html = `
		<div id="map"></div>
		<!--div id="explanation">OpenLayers displaying a .osm file directly. This <a href="display-osm.osm">display-osm.osm</a> is a very small example. Most .osm files would be too large to do this, and in general you're more likely to load in vector features in a different way</div-->
		`;
		document.body.insertAdjacentHTML('beforeend', html);
		let div = document.querySelector('div#map');
		window.map = build_map(div);
	}
	//window.map._addLayer(window.map.osm_layer());
	window.map._addLayer(window.map.bw_layer());
})
.then(() => {
	if (!program) {
		return Promise.resolve();
	}
	document.head.querySelector('title')
		.textContent = program;
	return jsLoad(program);
})
.then(() => jsLoad('./lib/spl-view4.js', true))
;

function onData(db, fetched) {
	
	let map = window.map,
		xplorer = window.xplorer;
	
	xplorer.setDb(db);
	for (let [mount, info] of Object.entries(fetched)) {
		if ('layers' in info) {
			for (let layer of info.layers) {
				map.addLayer(layer);
			}
		}
	}
	
	if (xplorer) {
		xplorer.addSnippets(
			window.extraSnippets || {});
	}
	map.show_map(window.viewOptions);
}
		</script>
		<!--script src="./lib/eruda.js" type="text/javascript"></script-->
	</body>
</html>
